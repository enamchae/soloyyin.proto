<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="UTF-8" />

		<style>
			video {
				max-width: 400px;
			}

			.db {
				background: #fdd;
			}

			.db.target {
				background: #bff;
			}
		</style>
	</head>

	<body>
		<div><button class="debugger">Debugger button</button></div>
		<div><button class="interaction">Interaction button</button></div>

		<div><video src="./samples/1.mp4" preload controls !!controller></video></div>

		<div><canvas></canvas></div>
		<div class="db">.-.</div>
		<div class="timedrift">._.</div>

		<script type="module">
import Skupper from "./Skupper.js";
import MinMaxerAnalyser from "./MinMaxerAnalyser.js";

document.querySelector(".debugger").addEventListener("click", () => {
	debugger;
});

const video = document.querySelector("video");

const canvas = document.querySelector("canvas");
const canvasContext = canvas.getContext("2d");

const drawTimeDomain = analyserBuffer => {
	canvasContext.save();
	canvasContext.resetTransform();
	canvasContext.clearRect(0, 0, canvas.width, canvas.height);
	canvasContext.restore();

	analyserBuffer.forEach((sample, i) => {
		canvasContext.fillRect(i, 0, 1, sample);
	});
};

const dbDisplay = document.querySelector(".db");
const timeDriftDisplay = document.querySelector(".timedrift");

const THRESHOLD_DB = -16;

(async () => {
	let cachedMaxDbfs = 0;

	const skupper = await Skupper.new(video, {
		lookbehindMargin: 0.5,
		lookaheadMargin: 0.5,

		onIteration: () => {
			const maxDbfs = cachedMaxDbfs = MinMaxerAnalyser.dbfsFromAmp(skupper.minMaxerAnalyser.maxAmpFromAnalyser());

			if (maxDbfs < THRESHOLD_DB) {
				video.playbackRate = 4;
			} else {
				video.playbackRate = 1;
			}
		},

		onAnimationFrame: () => {
			dbDisplay.textContent = cachedMaxDbfs;
			dbDisplay.classList.toggle("target", cachedMaxDbfs >= THRESHOLD_DB);

			timeDriftDisplay.textContent = skupper.synchronizer.targetVideoTimeDrift().toFixed(6);

			drawTimeDomain(skupper.minMaxerAnalyser.analyserBuffer);
		},
	});

	skupper.lookaheadMedia.controls = true;
	video.insertAdjacentElement("afterend", skupper.lookaheadMedia);

	// setInterval(async () => {
	// 	console.log(await skupper.minMaxer.pollExtrema());
	// }, 2000);

	canvas.width = skupper.minMaxerAnalyser.analyserBuffer.length;
	canvas.height = 120;
	canvasContext.scale(1, -canvas.height / 2);
	canvasContext.translate(0, -1);
	canvasContext.fillStyle = "#aaa";
	
/* 	const logEvent = event => console.log(`%c${event.type}`, "color: blue; font-weight: 700;");

	video.addEventListener("canplay", logEvent);
	video.addEventListener("loadeddata", logEvent);
	video.addEventListener("play", logEvent);
	video.addEventListener("stalled", logEvent);
	video.addEventListener("playing", logEvent);
	video.addEventListener("pause", logEvent);
	video.addEventListener("waiting", logEvent); 

	const logEvent2 = event => console.log(`%c${event.type}`, "color: green;");

	skupper.lookaheadMedia.addEventListener("canplay", logEvent2);
	skupper.lookaheadMedia.addEventListener("loadeddata", logEvent2);
	skupper.lookaheadMedia.addEventListener("play", logEvent2);
	skupper.lookaheadMedia.addEventListener("stalled", logEvent2);
	skupper.lookaheadMedia.addEventListener("playing", logEvent2);
	skupper.lookaheadMedia.addEventListener("pause", logEvent2);
	skupper.lookaheadMedia.addEventListener("waiting", logEvent2); */
})();
		</script>
	</body>
</html>